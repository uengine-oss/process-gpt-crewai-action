import time
import json
import logging
import asyncio
from typing import Dict, List, Optional, Any, Tuple
from processgpt_agent_utils.tools.dmn_rule_tool import DMNRuleTool
from processgpt_agent_utils.tools.knowledge_manager import Mem0Tool

# ë¡œê¹… ì„¤ì •
logger = logging.getLogger(__name__)


class DynamicPromptGenerator:
    """ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸° ì£¼ì–´ì§„ ì…ë ¥ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ Taskìš© descriptionê³¼ expected_outputì„ ìƒì„±í•©ë‹ˆë‹¤."""

    def __init__(self, llm):
        self.llm = llm


    async def generate_task_prompt(
        self,
        task_instructions: str,
        agent_info: List[Dict],
        form_types: Dict = None,
        form_html: str = "",
        feedback_summary: str = "",
        current_activity_name: str = "",
        user_info: Optional[List[Dict]] = None,
        sources: List[Dict] | None = None,
    ) -> Tuple[str, str]:
        """ë‘ LLM í˜¸ì¶œë¡œ ì„¤ëª…/ê²°ê³¼ë¬¼ì„ ë¶„ë¦¬ ìƒì„±í•˜ê³  asyncio.gatherë¡œ ë³‘ë ¬ ì‹¤í–‰."""

        learned_knowledge = self._collect_learned_knowledge(
            agent_info=agent_info,
            task_instructions=task_instructions,
            feedback_summary=feedback_summary,
        )

        dmn_analysis = self._collect_dmn_analysis(
            agent_info=agent_info,
            task_instructions=task_instructions,
        )

        # ì„¤ëª…ìš© ë¸Œë¦¬í”„: í¼ ì •ë³´ ì œì™¸
        desc_brief = self._build_description_prompt(
            task_instructions=task_instructions,
            agent_info=agent_info,
            user_info=user_info or [],
            feedback_summary=feedback_summary,
            current_activity_name=current_activity_name,
            learned_knowledge=learned_knowledge,
            dmn_analysis=dmn_analysis,
            form_types=form_types,
            sources=sources,
        )

        # ê²°ê³¼ë¬¼ìš© ë¸Œë¦¬í”„: í¼ ì •ë³´ë§Œ í¬í•¨
        expected_brief = self._build_expected_output_prompt(
            form_types=form_types,
            form_html=form_html,
        )

        description_system = self._build_system_prompt_description()
        expected_system = self._build_system_prompt_expected_output()

        async def ainvoke_text(system_prompt: str, user_prompt: str) -> str:
            """LLMì„ í˜¸ì¶œí•´ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë°›ì•„ìš”"""
            
            start_time = time.time()
            response = await self.llm.ainvoke([
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ])
            raw = getattr(response, "content", response)
            text = "".join(part.get("text", "") if isinstance(part, dict) else str(part) for part in raw) if isinstance(raw, list) else str(raw)
            text = (text or "").strip()
            logger.info("ğŸ“ LLM(ainvoke) ì™„ë£Œ - %.2fs, %d chars", time.time() - start_time, len(text))
            if not text:
                logger.error("âŒ LLM ë¹ˆ ì‘ë‹µ ìˆ˜ì‹ : system_prompt ê¸¸ì´=%d, user_prompt ê¸¸ì´=%d", len(system_prompt), len(user_prompt), exc_info=False)
                raise ValueError("Empty response from LLM")
            return text

        desc_task = asyncio.create_task(ainvoke_text(description_system, f"[ROLE=description]\n{desc_brief}\nì„¤ëª…ë§Œ í•œ ë¬¸ë‹¨ìœ¼ë¡œ."))
        out_task  = asyncio.create_task(ainvoke_text(expected_system, f"[ROLE=expected_output]\n{expected_brief}"))
        
        try:
            description, expected_output = await asyncio.gather(desc_task, out_task)
            logger.info("âœ… ë¹„ë™ê¸° ë¶„ë¦¬ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ")
            return description, expected_output
        except Exception as e:
            logger.error("âŒ ë™ì  Task description/expected_output ìƒì„± ì‹¤íŒ¨(raise): %s", e, exc_info=True)
            raise

    # ----------------------------
    # ë‚´ë¶€ ë¡œì§
    # ----------------------------
    def _collect_learned_knowledge(
        self,
        agent_info: List[Dict],
        task_instructions: str,
        feedback_summary: str,
    ) -> Dict[str, str]:
        """ì—ì´ì „íŠ¸ë³„ ê´€ë ¨ í•™ìŠµ ë‚´ìš© ìˆ˜ì§‘"""
        if not task_instructions or not task_instructions.strip():
            return {}

        query = f"{task_instructions.strip()}\n{feedback_summary.strip()}"
        logger.info("ğŸ§  mem0 ì‚¬ì „ í›ˆë ¨ ë°ì´í„° ê²€ìƒ‰ ì‹œì‘")

        learned: Dict[str, str] = {}
        for ag in agent_info:
            agent_id = ag.get("id")
            tenant_id = ag.get("tenant_id")
            role = ag.get("role", "Unknown")

            if not (agent_id and tenant_id):
                continue

            try:
                mem0_tool = Mem0Tool(tenant_id=tenant_id, user_id=agent_id)
                result = mem0_tool._run(query)
                if result and "ì§€ì‹ì´ ì—†ìŠµë‹ˆë‹¤" not in result:
                    learned[role] = result
            except Exception as e:
                logger.warning("âš ï¸ ì—ì´ì „íŠ¸ %s ë©”ëª¨ë¦¬ ê²€ìƒ‰ ì‹¤íŒ¨: %s", role, e)

        return learned


    def _build_description_prompt(
        self,
        task_instructions: str,
        agent_info: List[Dict],
        user_info: List[Dict],
        feedback_summary: str,
        current_activity_name: str,
        learned_knowledge: Dict[str, Any],
        dmn_analysis: Dict[str, str],
        form_types: Optional[Dict] = None,
        sources: List[Dict] | None = None,
    ) -> str:
        """ì„¤ëª… í”„ë¡¬í”„íŠ¸: form_types/form_html ì œì™¸, ë‚˜ë¨¸ì§€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì›ë¬¸ ìŠ¤íƒ€ì¼ë¡œ í¬í•¨."""
        
        has_feedback = bool(feedback_summary and feedback_summary.strip() and feedback_summary.strip() != 'ì—†ìŒ')
        has_learned = bool(learned_knowledge and any(str(v).strip() for v in learned_knowledge.values()))
        has_dmn = bool(dmn_analysis and any(str(v).strip() for v in dmn_analysis.values()))
        agent_info_json = json.dumps(agent_info or [], ensure_ascii=False, indent=2) if agent_info else 'ì •ë³´ ì—†ìŒ'
        user_info_json = json.dumps(user_info or [], ensure_ascii=False, indent=2) if user_info else 'ì •ë³´ ì—†ìŒ'
        learned_json = json.dumps(learned_knowledge or {}, ensure_ascii=False, indent=2) if has_learned else 'ê´€ë ¨ ê²½í—˜ ì—†ìŒ'
        dmn_json = json.dumps(dmn_analysis or {}, ensure_ascii=False, indent=2) if has_dmn else 'ê´€ë ¨ ê·œì¹™ ë¶„ì„ ì—†ìŒ'
        sources_json = json.dumps(sources or [], ensure_ascii=False, indent=2) if sources else 'ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ'
        # agent_infoì—ì„œ ì‹¤ì œ agent_idì™€ tenant_id ì¶”ì¶œ
        agent_context_info = []
        if agent_info:
            for ag in agent_info:
                agent_id = ag.get("id") or ag.get("user_id")
                tenant_id = ag.get("tenant_id")
                if agent_id and tenant_id:
                    agent_context_info.append(f"agent_id={agent_id}, tenant_id={tenant_id}")
        
        agent_context_text = "\n".join([f"- {info}" for info in agent_context_info]) if agent_context_info else "ì—†ìŒ"
        
        # form_typesì—ì„œ í•„ë“œ íƒ€ì… í™•ì¸
        has_slide_type = False
        has_report_type = False
        if form_types:
            form_fields = None
            if isinstance(form_types, dict) and ("fields" in form_types or "html" in form_types):
                form_fields = form_types.get("fields")
            else:
                form_fields = form_types if form_types else None
            
            if form_fields and isinstance(form_fields, list):
                for field in form_fields:
                    if isinstance(field, dict):
                        field_type = field.get("type", "").lower()
                        if field_type in ["slide", "presentation"]:
                            has_slide_type = True
                        elif field_type in ["report", "document"]:
                            has_report_type = True
        
        # ìŠ¬ë¼ì´ë“œì™€ ë¦¬í¬íŠ¸ í˜•ì‹ ì„¹ì…˜ ë‚´ìš© ìƒì„±
        slide_section = """**ìŠ¬ë¼ì´ë“œ í˜•ì‹ (presentation, slide ë“±):**
- **êµ¬ì¡°**: ì œëª© ìŠ¬ë¼ì´ë“œ â†’ ëª©ì°¨ â†’ ë³¸ë¬¸ ìŠ¬ë¼ì´ë“œë“¤ â†’ ê²°ë¡ /ì§ˆì˜ì‘ë‹µ ìŠ¬ë¼ì´ë“œ
- **ë¶„ëŸ‰**: ìµœì†Œ 10ì¥ ì´ìƒ êµ¬ì„±(ë§ì„ ìˆ˜ë¡ ì¢‹ìŒ)
- **í˜•ì‹**: reveal.js ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë¬¼ ìƒì„±
- **ë‚´ìš© ê¸°ë°˜**: ë³´ê³ ì„œê°€ ìˆì„ ê²½ìš° ë³´ê³ ì„œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ìŠ¬ë¼ì´ë“œ ìƒì„±, ì—†ìœ¼ë©´ ì£¼ì œì— ë§ê²Œ ì ì ˆíˆ ìƒì„±
- **ê¸°ìˆ ì  ìš”êµ¬ì‚¬í•­**:
  * reveal.js êµ¬ë¬¸ ì‚¬ìš© (ìƒˆ ìŠ¬ë¼ì´ë“œìš© ---, ìˆ˜ì§ ìŠ¬ë¼ì´ë“œìš© --)
  * ë¶ˆë¦¿ í¬ì¸íŠ¸, í—¤ë”, ê°•ì¡° í˜•ì‹ ì ì ˆíˆ í™œìš©
  * ë…¼ë¦¬ì  ìŠ¬ë¼ì´ë“œ ì „í™˜ê³¼ íë¦„
  * ê¹”ë”í•˜ê³  ì „ë¬¸ì ì¸ í”„ë ˆì  í…Œì´ì…˜ êµ¬ì¡°
  * ì ì ˆí•œ ê²½ìš° ì‚¬ìš©ì ì •ë³´ í†µí•©(ë°œí‘œì ì´ë¦„, ë¶€ì„œ ë“±)
- **ğŸš¨ ì¤‘ìš”í•œ ì¶œë ¥ í˜•ì‹ ê·œì¹™**:
  * ì ˆëŒ€ë¡œ ```markdown, ```html, ``` ê°™ì€ ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ ê²°ê³¼ë¥¼ ê°ì‹¸ì§€ ë§ˆì„¸ìš”
  * ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì„ ì¶œë ¥í•˜ì„¸ìš” (ì½”ë“œ ë¸”ë¡ ì—†ì´)
  * reveal.js ë§ˆí¬ë‹¤ìš´ êµ¬ë¬¸ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜, ì½”ë“œ ë¸”ë¡ìœ¼ë¡œ ê°ì‹¸ì§€ ë§ ê²ƒ
  * HTML ì£¼ì„ì´ë‚˜ ì½”ë“œ ë¸”ë¡ í˜•íƒœì˜ ê°ì‹¸ê¸°ëŠ” ì ˆëŒ€ ê¸ˆì§€

""" if has_slide_type else ""
        
        report_section = """**ë¦¬í¬íŠ¸ í˜•ì‹ (report, document ë“±):**
- **í˜•ì‹**: ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë¬¼ ìƒì„±
- **ê¸°ë³¸ êµ¬ì¡°**: ì„œë¡  â†’ ë³¸ë¡  â†’ ê²°ë¡  í˜•ì‹
- **ì†Œì œëª©ê³¼ ëª©ì°¨**: ë‚´ìš©ì— ë§ê²Œ ìœ ì—°í•˜ê²Œ ì ì ˆíˆ ì•Œì•„ì„œ ìƒì„±
- **ë‚´ìš© ì‘ì„± ì›ì¹™**:
  * ë°ì´í„° ê¸°ë°˜ ê°ê´€ì  ì„œìˆ 
  * ë…¼ë¦¬ì  íë¦„ê³¼ ê·¼ê±° ì œì‹œ
  * ë‚´ìš©ì´ ë§ì„ìˆ˜ë¡ ì¢‹ìŒ (ìƒì„¸í•˜ê³  í’ë¶€í•œ ë‚´ìš© ì‘ì„±)
- **ì¶œì²˜ í‘œê¸°**: ë‚´ìš©ì„ ê²€ìƒ‰ì´ë‚˜ ì°¸ê³  ìë£Œì—ì„œ ê°€ì ¸ì™”ë‹¤ë©´ ë°˜ë“œì‹œ ì¶œì²˜ ëª…ì‹œ
  * ë§ˆí¬ë‹¤ìš´ ë§í¬ í˜•ì‹: `[ì¶œì²˜ëª…](URL)` ë˜ëŠ” ê°ì£¼ í˜•ì‹ ì‚¬ìš©
  * ì°¸ê³ ë¬¸í—Œ ì„¹ì…˜ì— ëª¨ë“  ì¶œì²˜ ì •ë¦¬

""" if has_report_type else ""

        if has_feedback:
            first_priority_text = """ğŸ”¥ 1ìˆœìœ„ - í”¼ë“œë°± ì ˆëŒ€ ìš°ì„ :
   - í”¼ë“œë°± ìš”êµ¬ì‚¬í•­ì´ ëª¨ë“  ì§€ì‹œì‚¬í•­ë³´ë‹¤ ìš°ì„  (ì‘ì—…ì§€ì‹œì‚¬í•­, í•™ìŠµê²½í—˜ ë“± ëª¨ë‘ í”¼ë“œë°±ì— ì¢…ì†)
   - í”¼ë“œë°±ì—ì„œ ìš”êµ¬í•œ ë³€ê²½ì‚¬í•­ì„ ì •í™•íˆ ì´í•´í•˜ê³  100% ì ìš©
   - ê¸°ì¡´ ë°©ì‹/ê´€ë¡€ë¥¼ ì™„ì „íˆ ë²„ë¦¬ê³  í”¼ë“œë°±ì´ ì œì‹œí•œ ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ì „í™˜
   - í”¼ë“œë°± vs ë‹¤ë¥¸ ì§€ì‹œì‚¬í•­ ì¶©ëŒ ì‹œ â†’ ë¬´ì¡°ê±´ í”¼ë“œë°± ìš°ì„ 
   
   ğŸ”„ í”¼ë“œë°± ë™ì‚¬ë³„ ì‘ì—…ì§€ì‹œì‚¬í•­ ì¬í•´ì„ ê·œì¹™:
   - í”¼ë“œë°± "ì €ì¥" + ì‘ì—…ì§€ì‹œì‚¬í•­ "ìˆ˜ì •" â†’ INSERT ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬
   - í”¼ë“œë°± "ìˆ˜ì •" + ì‘ì—…ì§€ì‹œì‚¬í•­ "ì €ì¥" â†’ UPDATE ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬
   - í”¼ë“œë°± "ì‚­ì œ" + ì‘ì—…ì§€ì‹œì‚¬í•­ "ì €ì¥" â†’ DELETE ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬
   - í”¼ë“œë°± "ì¡°íšŒ" + ì‘ì—…ì§€ì‹œì‚¬í•­ "ì €ì¥" â†’ SELECT ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬
   - ì—¬ëŸ¬ê°€ì§€ ë™ì‚¬ê°€ ìˆìœ¼ë©´ í”¼ë“œë°±ì˜ ë™ì‚¬ê°€ ì‹¤ì œ ìˆ˜í–‰í•  ì‘ì—… ìœ í˜•ì„ ìµœì¢… ê²°ì •
   - í”¼ë“œë°±ì˜ ë™ì‚¬ê°€ ì‹¤ì œ ìˆ˜í–‰í•  ì‘ì—… ìœ í˜•ì„ ìµœì¢… ê²°ì •"""
        else:
            first_priority_text = "1ìˆœìœ„ - ì‘ì—…ì§€ì‹œì‚¬í•­ ê·¸ëŒ€ë¡œ ìˆ˜í–‰"

        if has_learned and has_feedback:
            second_priority_text = """2ìˆœìœ„ - DMN ê·œì¹™ ìš°ì„  í™œìš© ë° í•™ìŠµëœ ê²½í—˜ ì°¸ê³ :
   - í”¼ë“œë°± ë²”ìœ„ ë‚´ì—ì„œ DMN ê·œì¹™ì„ ìµœìš°ì„ ìœ¼ë¡œ í™œìš©í•˜ì—¬ ê·œì¹™ ê¸°ë°˜ ì¶”ë¡  ìˆ˜í–‰í•˜ê³ , í•™ìŠµëœ ê²½í—˜ì„ ë³´ì¡°ì ìœ¼ë¡œ ì°¸ê³ í•˜ì—¬ ë” ì™„ë²½í•˜ê²Œ ì²˜ë¦¬
   - DMN ê·œì¹™ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ê·¸ ê·œì¹™ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  ì¶”ë¡ ê³¼ ê²°ì •ì„ ìˆ˜í–‰í•˜ê³ , í”¼ë“œë°±ì´ ìš”êµ¬í•˜ëŠ” ë°©í–¥ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ê²½í—˜ìœ¼ë¡œ ë””í…Œì¼ ë³´ì™„"""
        elif has_learned:
            second_priority_text = """2ìˆœìœ„ - DMN ê·œì¹™ ìš°ì„  í™œìš© ë° í•™ìŠµëœ ê²½í—˜ ì°¸ê³ :
   - ì‘ì—…ì§€ì‹œì‚¬í•­ì€ ê·¸ëŒ€ë¡œ í•˜ë˜, DMN ê·œì¹™ì„ ìµœìš°ì„ ìœ¼ë¡œ í™œìš©í•˜ì—¬ ê·œì¹™ ê¸°ë°˜ ì¶”ë¡  ìˆ˜í–‰í•˜ê³ , í•™ìŠµëœ ê²½í—˜ì„ ë³´ì¡°ì ìœ¼ë¡œ ì°¸ê³ í•´ì„œ ë” ë””í…Œì¼í•˜ê³  ì™„ë²½í•˜ê²Œ ì²˜ë¦¬
   - DMN ê·œì¹™ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ê·¸ ê·œì¹™ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  ì¶”ë¡ ê³¼ ê²°ì •ì„ ìˆ˜í–‰í•˜ê³ , ê²½í—˜ì—ì„œ ì–»ì€ ë…¸í•˜ìš°ë¡œ í’ˆì§ˆê³¼ ì •í™•ì„± í–¥ìƒ"""
        else:
            second_priority_text = """2ìˆœìœ„ - DMN ê·œì¹™ ìš°ì„  í™œìš© ë° ì¼ë°˜ ë°°ê²½ì§€ì‹ ì°¸ê³ :
   - DMN ê·œì¹™ì„ ìµœìš°ì„ ìœ¼ë¡œ í™œìš©í•˜ì—¬ ê·œì¹™ ê¸°ë°˜ ì¶”ë¡  ìˆ˜í–‰í•˜ê³ , ì¼ë°˜ ë°°ê²½ì§€ì‹ì„ ë³´ì¡°ì ìœ¼ë¡œ ì°¸ê³ 
   - DMN ê·œì¹™ì´ ìˆìœ¼ë©´ ë°˜ë“œì‹œ ê·¸ ê·œì¹™ì„ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  ì¶”ë¡ ê³¼ ê²°ì •ì„ ìˆ˜í–‰"""

        return f"""
ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ CrewAI Task description í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”:

=== ğŸ“‹ ì„¹ì…˜ 1: ì…ë ¥ê°’ ì„¤ëª… ===

**í™œë™ëª… (current_activity_name):**
- ê°’: {current_activity_name or 'ì¼ë°˜ ì‘ì—…'}
- ì—­í• : í˜„ì¬ ìˆ˜í–‰ì¤‘ì¸ ì—…ë¬´ ì´ë¦„ì„ ë‚˜íƒ€ëƒ„
- í™œìš©: ì´ë¦„ì´ ì˜ë¯¸í•˜ëŠ” ì‘ì—…ì˜ ë°°ê²½ê³¼ ëª©ì  ì„¤ëª…ì— ì‚¬ìš©

**íŒ€ êµ¬ì„± (agent_info):**
- ê°’: {agent_info_json}
- ì—­í• : í˜‘ì—…í•  ì—ì´ì „íŠ¸ë“¤ì˜ ì—­í• , ID, í…Œë„ŒíŠ¸ ì •ë³´ ì œê³µ
- í™œìš©: ê° ì—ì´ì „íŠ¸ì˜ ì „ë¬¸ì„±ì„ ê³ ë ¤í•œ ì‘ì—… ë¶„ë°° ë° í˜‘ì—… ì§€ì‹œì— ì‚¬ìš©

**ë‹´ë‹¹ì(Owner) (user_info):**
- ê°’: {user_info_json}
- ì—­í• : í˜„ì¬ ì—…ë¬´ì˜ ì‹¤ì œ ë‹´ë‹¹ì ì •ë³´(ë‹´ë‹¹ì í‘œê¸°, ì—°ë½/ê²€í†  ì§€ì  ë°˜ì˜)
- í™œìš©: ê²°ê³¼ë¬¼ì— ë‹´ë‹¹ì/ì°¸ê°€ì ì •ë³´ê°€ ìš”êµ¬ë˜ë©´ ì ì ˆíˆ ë°˜ì˜

**ì‘ì—… ì§€ì‹œì‚¬í•­ (task_instructions):**
- ê°’: {task_instructions or 'ëª…ì‹œë˜ì§€ ì•ŠìŒ'}
- ì—­í• : ê¸°ë³¸ì ìœ¼ë¡œ ìˆ˜í–‰í•´ì•¼ í•  í•µì‹¬ ì—…ë¬´ ë‚´ìš©ê³¼ ì§€ì¹¨ ë° ì´ì „ ê²°ê³¼ë¬¼ë“¤ì— ëŒ€í•œ ì •ë¦¬ë³¸
- í™œìš©: Taskì˜ ì£¼ìš” ëª©í‘œì™€ ìˆ˜í–‰ ë°©ë²•ì˜ ê¸°ì¤€ì  (ë‹¨, í”¼ë“œë°±ì´ ìˆìœ¼ë©´ í”¼ë“œë°±ì— ì˜í•´ ì¬í•´ì„ë¨)

**í•™ìŠµëœ ê²½í—˜ (learned_knowledge):**
- ê°’: {learned_json}
- ì—­í• : ì—ì´ì „íŠ¸ë³„ ê´€ë ¨ ì—…ë¬´ ê²½í—˜ê³¼ ë…¸í•˜ìš° ì œê³µ
- í™œìš©: ì‘ì—… í’ˆì§ˆ í–¥ìƒê³¼ ì‹¤ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•œ ì°¸ê³  ìë£Œ
{('- ì°¸ê³ : í˜„ì¬ ìˆ˜í–‰í•  ì‘ì—…ì„ ë” ì™„ë²½í•˜ê²Œ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë””í…Œì¼ ë³´ì™„ì— í™œìš©' if has_learned else '- ì°¸ê³ : í•™ìŠµ ìë£Œ ë¶€ì¡± ì‹œì—ë„ ì‘ì—… ì¤‘ë‹¨ ê¸ˆì§€, ì¼ë°˜ ì§€ì‹ìœ¼ë¡œ ì´ˆì•ˆ ì‘ì„±')}

**DMN ê·œì¹™ ë¶„ì„ (dmn_rule):**
- ê°’: {dmn_json}
- ì—­í• : ê·œì¹™ì„ ê¸°ë°˜ìœ¼ë¡œ ì¶”ë¡ ëœ ë‹µë³€ ì œê³µ(í•™ìŠµëœ ê²½í—˜ë³´ë‹¤ ìš°ì„  ë°˜ì˜)
- í™œìš©: ì‘ì—…ì§€ì‹œì‚¬í•­ í•´ì„ ë° ì›ì ì‘ì—… ë„ì¶œ ì‹œ ê·œì¹™ìœ¼ë¡œ ì¶”ë¡ ëœ ê²°ê³¼ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ë°˜ì˜

**í”¼ë“œë°± (feedback_summary):**
- ê°’: {feedback_summary if has_feedback else 'ì—†ìŒ'}
- ì—­í• : ì´ì „ ì‘ì—…ì— ëŒ€í•œ ìˆ˜ì • ìš”êµ¬ì‚¬í•­ (ìµœê³  ìš°ì„ ìˆœìœ„)
- í™œìš©: ëª¨ë“  ë‹¤ë¥¸ ì§€ì‹œì‚¬í•­ë³´ë‹¤ ìš°ì„ í•˜ì—¬ ì‘ì—… ë°©í–¥ê³¼ ë°©ë²•ì„ ê²°ì •
{f'- ğŸ”¥ ìµœìš°ì„ : í”¼ë“œë°±ì´ ìˆìœ¼ë©´ ëª¨ë“  ì‘ì—…ì€ ì´ í”¼ë“œë°± ë‚´ìš©ì— ë”°ë¼ ì¬ì •ì˜ë¨' if has_feedback else ''}
- ì²˜ë¦¬ë°©ì‹: í”¼ë“œë°± ë™ì‚¬(ì €ì¥/ìˆ˜ì •/ì‚­ì œ/ì¡°íšŒ ë“±..)ê°€ ìˆìœ¼ë©´ ê·¸ì— ë§ê²Œ ì‘ì—…ì§€ì‹œì‚¬í•­ ì¬í•´ì„
- ì¶©ëŒí•´ê²°: í”¼ë“œë°± vs ì‘ì—…ì§€ì‹œì‚¬í•­ ì¶©ëŒ ì‹œ â†’ ë¬´ì¡°ê±´ í”¼ë“œë°± ìš°ì„  ì ìš©

**ì†ŒìŠ¤ íŒŒì¼ (sources):**
- ê°’: {sources_json}
- ì—­í• : ì‘ì—… ìˆ˜í–‰ì— í•„ìš”í•œ ì†ŒìŠ¤ íŒŒì¼ ì •ë³´ ì œê³µ
- í™œìš©: ì†ŒìŠ¤ íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ì‘ì—… ìˆ˜í–‰, file_path í•„ë“œë¥¼ í†µí•´ íŒŒì¼ ê²½ë¡œì— ì ‘ê·¼í•˜ì—¬ íŒŒì¼ ë‚´ìš©ì„ ì°¸ê³ 

=== ğŸ¯ ì„¹ì…˜ 2: ì‘ì—… ë²”ìœ„ ë° ë°©í–¥ ===

**ìš°ì„ ìˆœìœ„ ì²´ê³„:**
{first_priority_text}

{second_priority_text}

**ì‘ì—… ë²”ìœ„ ì œí•œ ì›ì¹™:**
- ì˜¤ë¡œì§€ì§€ ì‘ì—… ì§€ì‹œì‚¬í•­ê³¼ í”¼ë“œë°±ë§Œì˜ ì‘ì—… ë°©í–¥ì„ ê²°ì •
- ëª…ì‹œëœ ì‘ì—…ë§Œ ìˆ˜í–‰, ë¹„ëª…ì‹œ ì—°ê´€ì‘ì—…/í›„ì†ì‘ì—… ì ˆëŒ€ ê¸ˆì§€
- ì˜ˆì‹œ 1: "íœ´ê°€ ì •ë³´ ì €ì¥" â†’ ì˜¤ì§ íœ´ê°€ì •ë³´ë§Œ ì €ì¥, íœ´ê°€ì”ì—¬ì¼ìˆ˜ ìˆ˜ì •/ì•Œë¦¼ë°œì†¡/ìŠ¹ì¸ì²˜ë¦¬ ë“± ê¸ˆì§€
- ì˜ˆì‹œ 2: "ì£¼ë¬¸ ì •ë³´ ì €ì¥" â†’ ì˜¤ì§ ì£¼ë¬¸ì •ë³´ë§Œ ì €ì¥, ì¬ê³ ê°ì†Œ/í¬ì¸íŠ¸ì ë¦½/ì•Œë¦¼ë°œì†¡ ë“± ê¸ˆì§€
- ì˜ˆì‹œ 3: "ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •" â†’ ëª…ì‹œëœ ì‚¬ìš©ìì˜ ëª…ì‹œëœ í•„ë“œë§Œ ìˆ˜ì •, ë‹¤ë¥¸ ì‚¬ìš©ì/í•„ë“œ ìˆ˜ì • ê¸ˆì§€

**ë‹¤ì¤‘ ì‘ì—… ì²˜ë¦¬ ì›ì¹™:**
- ë°˜ë“œì‹œ ì‘ì—…ì§€ì‹œì‚¬í•­ì—ì„œ ì‹¤í–‰ ë™ì‚¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì›ì ì‘ì—…ì„ ëª¨ë‘ ì¶”ì¶œí•˜ì—¬ ëª©ë¡í™”(ì˜ˆ: ì €ì¥, í™•ì¸, ì¡°íšŒ ë“±)
- ëª¨ë“  ì›ì ì‘ì—…ì„ ë°˜ë“œì‹œ ìˆ˜í–‰í•´ì•¼ í•¨ 
- ì¦‰, ì‘ì—…ì§€ì‹œì— ì—¬ëŸ¬ ì‘ì—…ì´ ìˆì„ ê²½ìš° í•´ë‹¹ ì‘ì—…ì„ ëª¨ë‘ ìˆ˜í–‰í•´ì•¼ í•¨
- ì‘ì—… ê°„ ì„ í›„ê´€ê³„/ì˜ì¡´ì„±ì„ íŒŒì•…í•˜ì—¬ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ì‹¤í–‰

=== ğŸ’¾ ì„¹ì…˜ 3: ë°ì´í„° ì“°ê¸°/ìˆ˜ì • ì‹œ ì •í™•ì„± ë³´ì¥ ===

**ë°ì´í„° ì™„ì „ì„± í™•ë³´ ì ˆì°¨:**
1. ì‘ì—… ì§€ì‹œì‚¬í•­ì—ì„œ í•„ìš”í•œ ëª¨ë“  ë°ì´í„° íŒŒì•…
2. ë¶€ì¡±í•œ ë°ì´í„°ëŠ” ì½ê¸°ì „ìš© ë„êµ¬ë¡œ ì¡°íšŒ/ê²€ì¦/ë³´ì™„ (SELECT ì¿¼ë¦¬, ê²€ìƒ‰ API, ë©”ì‹œì§• API ë“±)
3. ëª¨ë“  í•„ìš” ë°ì´í„°ê°€ ì™„ì „í•´ì§„ í›„ì—ë§Œ ì“°ê¸° ì‘ì—… ìˆ˜í–‰
4. ë°ì´í„°ë¥¼ ì €ì¥ ë° ìˆ˜ì •í•  ê²½ìš°, ì£¼ì–´ì§„ ê°’ì„ ìµœëŒ€í•œ í™œìš©í•´ì„œ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ê°’ì„ ì¡°íšŒí•˜ëŠ” ë“±, íˆ´ì„ ì ê·¹ í™œìš©í•´ì„œ ì™„ì „í•œ ë°ì´í„°ë¥¼ ìƒì„± ë° ìˆ˜ì •í•´ì•¼ í•¨, ì ˆëŒ€ ëˆ„ë½ë˜ëŠ” ì»¬ëŸ¼ì´ë‚˜ ë°ì´í„°ê°€ ìˆì–´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤.

=== ğŸ¨ ì„¹ì…˜ 4: ì½˜í…ì¸  ìƒì„± ì‹œ ê°€ì´ë“œë¼ì¸ ===

**í¼ í˜•ì‹ë³„ ì°½ì˜ì  ì½˜í…ì¸  ìƒì„± ì›ì¹™:**

{slide_section}{report_section}**ì¼ë°˜ í¼ ë°ì´í„° ìƒì„±:**
- í¼ íƒ€ì…ì˜ ì´ë¦„ê³¼ ìš©ë„ì— ë§ëŠ” ì ì ˆí•œ ë‚´ìš© ìƒì„±
- í¼ íƒ€ì…ì˜ ëª¨ë“  í•„ìˆ˜ í•„ë“œ ì™„ì „íˆ ì±„ì›€
- ì‹¤ì œ ì—…ë¬´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ë°ì´í„° ìƒì„±
- ì¼ê´€ì„± ìˆëŠ” ë°ì´í„° ê´€ê³„ ìœ ì§€ (ì˜ˆ: ë¶€ì„œ-ì§ì±…-ê¶Œí•œ ë§¤ì¹­)
- í¼ì˜ ëª©ì ê³¼ ë§¥ë½ì— ë¶€í•©í•˜ëŠ” ì˜ë¯¸ ìˆëŠ” ë°ì´í„° ìƒì„±

**íŒŒì¼ ìƒì„± ì‘ì—… í•„ìˆ˜ ì¡°ê±´:**
- ì‘ì—… ì§€ì‹œì‚¬í•­(task_instructions)ì„ ë¶„ì„í•˜ì—¬ íŒŒì¼ ìƒì„± ìš”ì²­ì¸ì§€ íŒë‹¨í•˜ì„¸ìš”
- íŒŒì¼ ìƒì„± ìš”ì²­(ì˜ˆ: ë¬¸ì„œ ì‘ì„±, ë¦¬í¬íŠ¸ ìƒì„±, í”„ë ˆì  í…Œì´ì…˜ ì œì‘, ì´ë¯¸ì§€ ìƒì„±, ë°ì´í„° íŒŒì¼ ìƒì„± ë“±)ì´ í¬í•¨ëœ ê²½ìš°, ë°˜ë“œì‹œ ë‹¤ìŒì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
  * ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLì„ ì œê³µí•  ìˆ˜ ìˆëŠ” ë„êµ¬ë‚˜ ìŠ¤í‚¬ì„ í™œìš©í•˜ì—¬ ê²°ê³¼ë¬¼ì„ ì œê³µ
  * ìƒì„±ëœ íŒŒì¼ì„ Supabase ë˜ëŠ” ê¸°íƒ€ ìŠ¤í† ë¦¬ì§€ì— ì—…ë¡œë“œ
  * ì—…ë¡œë“œëœ íŒŒì¼ì˜ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLì„ íšë“
  * URLì˜ ìœ íš¨ì„± ë° ì ‘ê·¼ ê¶Œí•œì„ ê²€ì¦
  * í¼_ë°ì´í„°ì— ë‹¤ìš´ë¡œë“œ URL í•„ë“œë¥¼ í¬í•¨ (ì˜ˆ: download_url, file_download_url ë“± ëª…í™•í•œ í‚¤ ì‚¬ìš©)
- í•´ë‹¹ ë„êµ¬/ìŠ¤í‚¬ì´ ì—†ë‹¤ë©´ ë¨¼ì € ì í•©í•œ ë„êµ¬ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ì‚¬ìš© ë¶ˆê°€ ì‹œ ëª…í™•í•œ ì‚¬ìœ ì™€ í•¨ê»˜ ì‹¤íŒ¨ ìƒíƒœë¡œ ë³´ê³ 
- ìƒì„±ëœ íŒŒì¼ì€ ì‚¬ìš©ìë‚˜ í›„ì† ì‹œìŠ¤í…œì´ ì¦‰ì‹œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì œê³µë˜ì–´ì•¼ í•©ë‹ˆë‹¤

**ì‘ì—… ì§€ì‹œì‚¬í•­ ë¶„ì„ ë° êµ¬ì²´í™” ì›ì¹™:**
- ì‘ì—… ì§€ì‹œì‚¬í•­(task_instructions)ì„ ë¨¼ì € ë¶„ì„í•˜ì—¬ ìš”ì²­ì˜ ì„±ê²©ê³¼ êµ¬ì²´ì„±ì„ íŒë‹¨í•˜ì„¸ìš”
- ì‘ì—… ì§€ì‹œì‚¬í•­ì´ ëª¨í˜¸í•˜ê±°ë‚˜ ë‹¨ìˆœí•œ ìš”ì²­ í˜•íƒœ(ì˜ˆ: "PPT ë§Œë“¤ì–´ì¤˜", "ë³´ê³ ì„œ ì‘ì„±í•´ì¤˜" ë“±)ì¸ ê²½ìš°, ì‹¤ì œ ìˆ˜í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ë‹¨ê³„ë¡œ ì„¸ë¶„í™”í•˜ì—¬ Task descriptionì„ ì‘ì„±í•˜ì„¸ìš”
- ë‹¨ìˆœ ì§€ì‹œë¥¼ ê·¸ëŒ€ë¡œ ì¬ì§„ìˆ í•˜ì§€ ë§ê³ , ë‹¤ìŒì„ í¬í•¨í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìƒì„¸ ì•¡ì…˜ í”Œëœì„ ì‘ì„±í•˜ì„¸ìš”:
  * íŒŒì¼ ìƒì„±, ì‹¤í–‰, ì—…ë¡œë“œ, URL ì œê³µ ë“± í•„ìˆ˜ ì ˆì°¨ì˜ ëª…í™•í•œ ì •ì˜
  * ì‚¬ìš©í•  ë„êµ¬ì™€ ìŠ¤í‚¬ì˜ êµ¬ì²´ì  ì§€ì •
  * Supabase ë° ê¸°íƒ€ ìŠ¤í† ë¦¬ì§€/ì „ì†¡ ë„êµ¬ë¥¼ í™œìš©í•œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ ì ˆì°¨
  * ê²€ì¦ëœ ë‹¤ìš´ë¡œë“œ URL ì œê³µì„ ìœ„í•œ ë‹¨ê³„ë³„ ì§€ì¹¨
  * ê° ë‹¨ê³„ë³„ ê²€ì¦ ì ˆì°¨
- ì‘ì—… ì§€ì‹œì‚¬í•­ì´ ì´ë¯¸ êµ¬ì²´ì ì´ê³  ìƒì„¸í•œ ê²½ìš°ì—ëŠ” ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ë˜, ëˆ„ë½ëœ ì‹¤í–‰ ë‹¨ê³„ê°€ ìˆë‹¤ë©´ ë³´ì™„í•˜ì„¸ìš”

**ë„êµ¬ í™œìš© ê¸°ë³¸ ì›ì¹™:**
- ì œê³µëœ ë„êµ¬ì™€ ìŠ¤í‚¬ì€ ê°€ëŠ¥í•œ í•œ ê´‘ë²”ìœ„í•˜ê²Œ ëª¨ë‘ í™œìš©í•˜ì—¬ ì •ë³´ ìˆ˜ì§‘ê³¼ ì‘ì—… ìˆ˜í–‰ ì •í™•ë„ë¥¼ ë†’ì¼ ê²ƒ
- ì‹¤í–‰í˜• ë„êµ¬ê°€ ì˜ì¡´ì„±Â·í™˜ê²½ ì˜¤ë¥˜ë¥¼ ë³´ê³ í•˜ë©´ ì¦‰ì‹œ 'run_shell' ë“± í™˜ê²½ ì„¤ì • ë„êµ¬ë¡œ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜Â·ì„¤ì •ì„ ìˆ˜í–‰í•˜ê³ , ë™ì¼ ì‘ì—…ì„ ì¬ì‹œë„í•˜ì—¬ ì„±ê³µ ì—¬ë¶€ë¥¼ í™•ì¸
- íŠ¹ì • ë„êµ¬ ì‚¬ìš©ì´ ì‹¤íŒ¨í•˜ê±°ë‚˜ ì œí•œë˜ëŠ” ê²½ìš°, ë™ì¼ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë„êµ¬/ìŠ¤í‚¬ì„ ì¦‰ì‹œ íƒìƒ‰í•˜ì—¬ ëŒ€ì²´ ì‹¤í–‰
- ëŒ€ì²´ ë„êµ¬ ì‚¬ìš© ì‹œì—ë„ ê²°ê³¼ ë°ì´í„°ì˜ ì™„ì „ì„±ê³¼ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ë©°, í•„ìš” ì‹œ ë³µìˆ˜ ë„êµ¬ë¥¼ ì—°ê³„ ì‚¬ìš©
- **ë„êµ¬ íŒŒë¼ë¯¸í„° ì‚¬ìš© ê·œì¹™:**
  * ë„êµ¬ í˜¸ì¶œ ì‹œ agent_idë‚˜ tenant_id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•œ ê²½ìš°, ë°˜ë“œì‹œ ì•„ë˜ì˜ ì‹¤ì œ ê°’ì„ ì‚¬ìš©í•´ì•¼ í•¨
  * ì ˆëŒ€ë¡œ ì„ì˜ì˜ ê°’ì´ë‚˜ ë™ì ìœ¼ë¡œ ìƒì„±í•œ ê°’ì„ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ
  * ì‹¤ì œ agent_idì™€ tenant_id ê°’:
{agent_context_text}

**ì½˜í…ì¸  ìƒì„± ì‹œ ì£¼ì˜ì‚¬í•­:**
- ëª¨ë“  ê°€ìš© ë„êµ¬ë¥¼ ì ê·¹ í™œìš©í•˜ì—¬ ì •ë³´ ìˆ˜ì§‘:
  * ëª¨ë“  ë„êµ¬ë¥¼ í™œìš©í•˜ê³ ë„, ì •ë³´ê°€ ì—†ê±°ë‚˜ ë¶€ì¡±í•  ê²½ìš°, ë°°ê²½ ì§€ì‹ê³¼ ì£¼ì–´ì§„ ë¬¸ë§¥ íë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±
  * ë„êµ¬ì—ë§Œ ì˜ì¡´í•˜ì§€ë§ê³ , ë°°ê²½ ì§€ì‹ê³¼ ì£¼ì–´ì§„ ë¬¸ë§¥ íë¦„ì„ ê¸°ë°˜ìœ¼ë¡œë„ ì‘ì„±
  * ì‹¤ì œë¡œ ì—ì´ì „íŠ¸ì—ê²Œ ì£¼ì–´ì§„ ëª¨ë“  ë„êµ¬ë¥¼ ë°˜ë“œì‹œ í™œìš©
  * ë‹¨! ë©”ëª¨ë¦¬ ê´€ë ¨ ë„êµ¬(mem0, memento)ëŠ” ë³´ì¡° ì°¸ê³ ìš©ìœ¼ë¡œ, ì´ ê²°ê³¼ê°€ ì—†ë”ë¼ë„ ì‘ì—… ì¤‘ë‹¨ ë° ì‹¤íŒ¨ ê¸ˆì§€
  * í¼ ìš”êµ¬ì‚¬í•­ê³¼ ì‘ì—… ë§¥ë½ì— ë§ëŠ” ì ì ˆí•œ ë‚´ìš© ìƒì„±
  * ì—¬ëŸ¬ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬, ìµœëŒ€í•œ ë§ì€ ì •ë³´ë¥¼ ìˆ˜ì§‘
  (ì˜ˆ : DB ì¡°íšŒ ê´€ë ¨ ì‘ì—…ì´ë©´, supabase íˆ´ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒ)
  * íŒŒì¼ ìƒì„± ì‘ì—…ì´ë©´, 'upload_file' ê°™ì€ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLì„ í¼ ë‚´ì—­ ìµœìƒë‹¨ì— ë°˜ì˜í•˜ì—¬ ì œê³µ
  * URLì€ ë°˜ë“œì‹œ ì‹¤ì œ ì ‘ê·¼ ê°€ëŠ¥í•œ URLì´ì–´ì•¼ í•˜ë©°, href ì†ì„±ì„ í¬í•¨í•˜ì—¬ ì œê³µ

=== ğŸ“¤ í”„ë¡¬í”„íŠ¸ ìƒì„± ìµœì¢… ì§€ì¹¨ ===

**ë‹¬ì„± ëª©í‘œ (ì‘ì—…ì§€ì‹œì‚¬í•­ ë²”ìœ„ ë‚´ì—ì„œë§Œ):**
- êµ¬ì²´ì ìœ¼ë¡œ ë¬´ì—‡ì„ ì™„ì„±í•´ì•¼ í•˜ëŠ”ì§€
- ì–´ë–¤ í’ˆì§ˆê³¼ ê¸°ì¤€ì„ ë§Œì¡±í•´ì•¼ í•˜ëŠ”ì§€
- íŠ¹ë³„íˆ ì£¼ì˜í•´ì•¼ í•  ìš”êµ¬ì‚¬í•­ì´ ìˆëŠ”ì§€
- ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ ì‘ì—…ì€ ì ˆëŒ€ ìˆ˜í–‰í•˜ì§€ ì•Šì„ ê²ƒ
- ë°ì´í„° ì²˜ë¦¬ ì‹œ ì™„ì „ì„±ê³¼ ì •í™•ì„±ì„ ë³´ì¥í•  ê²ƒ

**ì„±ê³µ ê¸°ì¤€:**
- ëª…ì‹œëœ ëª©í‘œë“¤ì´ ì „ë¶€ ë‹¬ì„±ë˜ì–´ì•¼ í•¨ (ì¼ë¶€ë§Œ ë‹¬ì„±í•˜ë©´ ì‹¤íŒ¨ì´ë©°, ì‹¤íŒ¨ ì‹œ ë°˜ë“œì‹œ ì‚¬ìœ ë¥¼ ë””í…Œì¼í•˜ê²Œ ëª…ì‹œ)
{('- í”¼ë“œë°± ë‚´ìš©ì„ 100% ë°˜ì˜í•˜ì—¬ ì²˜ë¦¬' if has_feedback else '')}
- ìš”êµ¬ëœ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ ì œê³µ
- ì‘ì—… ë²”ìœ„ ì—„ìˆ˜ í™•ì¸
"""

    def _build_expected_output_prompt(
        self,
        form_types: Optional[Dict],
        form_html: str,
    ) -> str:
        """ê²°ê³¼ë¬¼ í”„ë¡¬í”„íŠ¸: form_types/form_htmlë§Œ í¬í•¨(ì›ë¬¸ í¼ ì„¹ì…˜ + ì„ íƒí˜• ê·œì¹™)."""
        
        has_form_types = bool(form_types)
        form_fields = None
        form_html_text = form_html or ""
        if isinstance(form_types, dict) and ("fields" in form_types or "html" in form_types):
            form_fields = form_types.get("fields")
            html = form_types.get("html")
            if html and isinstance(html, str) and html.strip():
                form_html_text = html
        else:
            form_fields = form_types if form_types else None
        is_multidata_mode = bool(form_html_text and 'is_multidata_mode="true"' in form_html_text)

        # ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ íƒ€ì… í•„ë“œ ê°ì§€
        report_slide_fields = []
        if form_fields and isinstance(form_fields, list):
            for field in form_fields:
                if isinstance(field, dict):
                    field_type = field.get("type", "").lower()
                    field_key = field.get("key", "")
                    if field_type in ["report", "document", "slide", "presentation"] and field_key:
                        report_slide_fields.append({
                            "key": field_key,
                            "type": field_type
                        })

        form_fields_json = json.dumps(form_fields, ensure_ascii=False, indent=2) if form_fields else 'íŠ¹ë³„í•œ í˜•ì‹ ì œì•½ ì—†ìŒ'
        multidata_notice = (
            '- ğŸš¨ ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ: is_multidata_mode="true" ì†ì„±ì´ ìˆìœ¼ë©´ í•´ë‹¹ í•„ë“œëŠ” ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜í•´ì•¼ í•¨\n\n'
            if is_multidata_mode else ''
        )
        
        # ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ íƒ€ì… í•„ë“œ ì²˜ë¦¬ ì§€ì¹¨ ìƒì„±
        report_slide_notice = ""
        if report_slide_fields:
            field_names = [f['key'] for f in report_slide_fields]
            report_slide_notice = (
                f"\n"
                f"ì„¹ì…˜ 7) ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ íƒ€ì… í•„ë“œ ì²˜ë¦¬ (ğŸš¨ í•„ìˆ˜)\n"
                f"- ë‹¤ìŒ í•„ë“œë“¤ì€ ë¦¬í¬íŠ¸ ë˜ëŠ” ìŠ¬ë¼ì´ë“œ íƒ€ì…ì…ë‹ˆë‹¤: {', '.join(field_names)}\n"
                f"- ì´ í•„ë“œë“¤ì˜ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì€ í¼_ë°ì´í„°ì— í¬í•¨í•˜ì§€ ë§ê³ , ë³„ë„ì˜ JSON ê°ì²´ë¡œ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤\n"
                f"- ê° í•„ë“œì˜ í‚¤ ì´ë¦„(ì˜ˆ: 'budget_report', 'budget_slide')ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ë³„ë„ JSON ìƒì„±\n"
                f"- ë°˜í™˜ í˜•ì‹: ê° í•„ë“œë§ˆë‹¤ ë…ë¦½ì ì¸ JSON ê°ì²´ë¡œ ë°˜í™˜\n"
                f"  ì˜ˆì‹œ 1 (ë¦¬í¬íŠ¸ í•„ë“œê°€ ìˆëŠ” ê²½ìš°):\n"
                f"  {{\"budget_report\": \"# ë¦¬í¬íŠ¸ ì œëª©\\n\\në¦¬í¬íŠ¸ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©...\"}}\n"
                f"  ì˜ˆì‹œ 2 (ìŠ¬ë¼ì´ë“œ í•„ë“œê°€ ìˆëŠ” ê²½ìš°):\n"
                f"  {{\"budget_slide\": \"---\\n\\n# ìŠ¬ë¼ì´ë“œ ì œëª©\\n\\nìŠ¬ë¼ì´ë“œ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©...\"}}\n"
                f"  ì˜ˆì‹œ 3 (ë¦¬í¬íŠ¸ì™€ ìŠ¬ë¼ì´ë“œ ë‘˜ ë‹¤ ìˆëŠ” ê²½ìš°):\n"
                f"  {{\"budget_report\": \"# ë¦¬í¬íŠ¸ ì œëª©\\n\\në¦¬í¬íŠ¸ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©...\"}}\n"
                f"  {{\"budget_slide\": \"---\\n\\n# ìŠ¬ë¼ì´ë“œ ì œëª©\\n\\nìŠ¬ë¼ì´ë“œ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©...\"}}\n"
                f"- ğŸš¨ ì¤‘ìš” ê·œì¹™:\n"
                f"  * ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ íƒ€ì… í•„ë“œëŠ” í¼_ë°ì´í„°ì— í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n"
                f"  * ê° í•„ë“œì˜ ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì„ í•´ë‹¹ í•„ë“œì˜ í‚¤ ì´ë¦„ìœ¼ë¡œ ë³„ë„ JSON ê°ì²´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤\n"
                f"  * í‚¤ ì´ë¦„ì€ í¼ í•„ë“œì˜ 'key' ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤ (ì˜ˆ: 'budget_report', 'budget_slide')\n"
                f"  * ë§ˆí¬ë‹¤ìš´ ë‚´ìš©ì€ ì½”ë“œ ë¸”ë¡(```)ìœ¼ë¡œ ê°ì‹¸ì§€ ë§ê³  ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤\n"
                f"  * ì—¬ëŸ¬ ê°œì˜ ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ í•„ë“œê°€ ìˆìœ¼ë©´ ê°ê° ë³„ë„ JSON ê°ì²´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤\n\n"
            )

        return (
            "ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ CrewAI Task expected_output í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”:\n\n"
            "=== ğŸ“‹ í¼ ì„¹ì…˜ (expected_output ì „ìš©) ===\n\n"
            "ì„¹ì…˜ 1) í¼ í˜•ì‹(form_types)\n"
            f"- ê°’(í•„ë“œ ì •ì˜): {form_fields_json}\n"
            f"- ê°’(HTML): {form_html_text if form_html_text else 'ì—†ìŒ'}\n"
            "- ì—­í• : ìµœì¢… ê²°ê³¼ë¬¼ì˜ êµ¬ì¡°ì™€ í•„ë“œ ì •ì˜, ì„ íƒí˜• í•­ëª©(items) ì œê³µ\n"
            "- í™œìš©: expected_output êµ¬ì¡° ì„¤ê³„ì™€ í¼_ë°ì´í„° í‚¤/ê°’ ê²°ì •ì— ì‚¬ìš©\n"
            f"{('- ì£¼ì˜: key ê°’ì„ ë³€ê²½ ì—†ì´ ì •í™•íˆ í•„ë“œëª…ìœ¼ë¡œ ì‚¬ìš©í•´ì•¼ í•¨' if has_form_types else '')}\n"
            f"{multidata_notice}"
            "ì„¹ì…˜ 2) ì„ íƒí˜•(radio/select) ì²˜ë¦¬\n"
            "- form_fieldsì˜ typeì´ 'radio' ë˜ëŠ” 'select'ì¸ ê²½ìš°, ê°’ ëª©ë¡ì€ form_typesì˜ HTMLì—ì„œ ì¶”ì¶œ\n"
            "- ì˜ˆ: <radio-field name=\"review_result\" items=\"[{{{'approve':'ìŠ¹ì¸'}}},{{{'reject':'ë°˜ë ¤'}}}]\" ...>\n"
            "- íŒŒì‹± ê·œì¹™:\n"
            "  1) HTMLì˜ items ì†ì„± ë¬¸ìì—´ì„ JSONìœ¼ë¡œ ë³€í™˜(ë‹¨ì¼ë”°ì˜´í‘œ â†’ ìŒë”°ì˜´í‘œ) í›„ íŒŒì‹±\n"
            "  2) í•­ëª© ê°ì²´ì˜ keyê°€ ì‹¤ì œ ì €ì¥ ê°’, valueëŠ” í•œê¸€ ë¼ë²¨\n"
            "  3) ìµœì¢… í¼_ë°ì´í„°ì—ëŠ” key ê°’ ì‚¬ìš© (ì˜ˆ: 'approve' ë˜ëŠ” 'reject')\n"
            "  4) radio/select ì™¸ í•„ë“œëŠ” typeì— ë§ëŠ” ì ì ˆí•œ í…ìŠ¤íŠ¸/ìˆ«ì í˜•ì‹ ì‚¬ìš©\n"
            "  5) user-select-fieldëŠ” ë‹´ë‹¹ì(Owner)ì˜ ì‹ë³„ì ì‚¬ìš© (id ìš°ì„ , ì—†ìœ¼ë©´ email)\n\n"
            "ì„¹ì…˜ 3) expected_output ìƒì„¸ ì‘ì„± ì§€ì¹¨\n"
            "- ë°˜ë“œì‹œ JSON ê°ì²´(object)ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ë¬¸ìì—´ í¬ì¥/ë°±í‹±/ì½”ë“œë¸”ë¡ ê¸ˆì§€\n"
            "- ì•„ë˜ ì˜ˆì‹œëŠ” êµ¬ì¡° ì˜ˆì‹œì´ë©°, ê°’ì€ ë°˜ë“œì‹œ ì‹¤ì œ ì‘ì—… ê²°ê³¼ë¡œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤\n\n"
            "[ì¼ë°˜ ëª¨ë“œ ì˜ˆì‹œ (is_multidata_mode=\"false\" ë˜ëŠ” ì—†ìŒ)]\n"
            "{\n  \"ìƒíƒœ\": \"SUCCESS\" ë˜ëŠ” \"FAILED\",\n  \"ìˆ˜í–‰í•œ_ì‘ì—…\": \"ì½ê¸° ì¢‹ì€ ìì—°ì–´ í…ìŠ¤íŠ¸ë¡œ ìˆ˜í–‰ ë‚´ì—­ì„ ë¬¸ë‹¨/ë¶ˆë¦¿ í˜•íƒœë¡œ ì„œìˆ \",\n  \"í¼_ë°ì´í„°\": {\n    // í¼íƒ€ì…ì— ë§ëŠ” ì‹¤ì œ ë°ì´í„° (ë°˜ë“œì‹œ key ê°’ì„ í•„ë“œëª…ìœ¼ë¡œ ì‚¬ìš©)\n    form_key : ì‹¤ì œ ë°ì´í„° ê°’\n  }\n}\n\n"
            "[ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ ì˜ˆì‹œ (is_multidata_mode=\"true\")]\n"
            "{\n  \"ìƒíƒœ\": \"SUCCESS\" ë˜ëŠ” \"FAILED\", \n  \"ìˆ˜í–‰í•œ_ì‘ì—…\": \"ì½ê¸° ì¢‹ì€ ìì—°ì–´ í…ìŠ¤íŠ¸ë¡œ ìˆ˜í–‰ ë‚´ì—­ì„ ë¬¸ë‹¨/ë¶ˆë¦¿ í˜•íƒœë¡œ ì„œìˆ \",\n  \"í¼_ë°ì´í„°\": {\n    // ì¼ë°˜ í•„ë“œ\n    normal_field : ì‹¤ì œ ë°ì´í„° ê°’,\n    // ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ í•„ë“œëŠ” ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜ (HTMLì˜ ì‹¤ì œ name ì†ì„± ì‚¬ìš© ì„ì˜ë¡œ ìƒì„± ê¸ˆì§€)\n    real_multidata_field_name : [\n      {\n        \"property1\": \"ì‹¤ì œ ì†ì„± ê°’\",\n        \"property2\": \"ì‹¤ì œ ì†ì„± ê°’\",\n        \"property3\": \"ì‹¤ì œ ì†ì„± ê°’\"\n      },\n      {\n        \"property1\": \"ì‹¤ì œ ì†ì„± ê°’2\",\n        \"property2\": \"ì‹¤ì œ ì†ì„± ê°’2\",\n        \"property3\": \"ì‹¤ì œ ì†ì„± ê°’2\",\n      }\n    ]\n  }\n}\n\n"
            "- ìœ„ êµ¬ì¡°ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. ì˜ˆì‹œ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ê³  ì‹¤ì œ ê²°ê³¼ë¡œ ëŒ€ì²´í•˜ì„¸ìš”\n"
            "- í¼_ë°ì´í„° í‚¤ ê·œì¹™: í¼íƒ€ì…ì˜ 'key' ê°’ì„ ë³€ê²½ ì—†ì´ ì›ë³¸ ê·¸ëŒ€ë¡œ ì •í™•íˆ í•„ë“œëª…ìœ¼ë¡œ ì‚¬ìš©\n"
            "- í¼_ë°ì´í„°ì—ëŠ” ìš”êµ¬ëœ í¼íƒ€ì… í•„ë“œë“¤ì´ ì •í™•íˆ í¬í•¨ë˜ì–´ì•¼ í•¨\n"
            "- 'ìˆ˜í–‰í•œ_ì‘ì—…'ì€ ê°€ë…ì„± ì¢‹ì€ ìì—°ì–´ í•œ ë¬¸ìì—´(ë¶ˆë¦¿/ë²ˆí˜¸ í—ˆìš©)ë¡œ ì‘ì„±\n"
            "- ì‘ì—…ì§€ì‹œì‚¬í•­ì—ì„œ ì¶”ì¶œí•œ ëª¨ë“  ì›ì ì‘ì—…ì„ ëˆ„ë½ ì—†ì´ ì„œìˆ (ëˆ„ë½ ì‹œ FAILED ê°„ì£¼)\n"
            "- ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ: is_multidata_mode=\"true\" í•„ë“œëŠ” ë°˜ë“œì‹œ ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜(HTMLì˜ ì‹¤ì œ name ì‚¬ìš©)\n\n"
            "ì„¹ì…˜ 4) ì„ íƒí˜•(radio/select) ê°’ ê²°ì • ì§€ì¹¨\n"
            "- form_typesì— HTMLì´ ì œê³µë˜ë©´ í•´ë‹¹ í•„ë“œì˜ itemsë¥¼ HTMLì—ì„œ íŒŒì‹±í•˜ì—¬ ì‹¤ì œ ì„ íƒ ê°€ëŠ¥í•œ ê°’ ëª©ë¡ ê²°ì •\n"
            "- items ì˜ˆì‹œ: [{\"approve\":\"ìŠ¹ì¸\"},{\"reject\":\"ë°˜ë ¤\"}] â†’ í¼_ë°ì´í„° ê°’ì€ \"approve\" ë˜ëŠ” \"reject\" ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•¨\n\n"
            "ì„¹ì…˜ 5) ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ í•„ë“œ ì²˜ë¦¬ ì§€ì¹¨\n"
            "- HTMLì—ì„œ is_multidata_mode=\"true\" ì†ì„±ì´ ìˆëŠ” í•„ë“œëŠ” ë°˜ë“œì‹œ ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜\n"
            "- ë°°ì—´ ë‚´ ê° ê°ì²´ëŠ” í•´ë‹¹ ì„¹ì…˜ì˜ ëª¨ë“  í•„ë“œë¥¼ í¬í•¨í•´ì•¼ í•¨\n"
            "- ë‹¤ì¤‘ ë°ì´í„° ëª¨ë“œ í•„ë“œì˜ ê° ë°°ì—´ ìš”ì†ŒëŠ” ë…ë¦½ì ì¸ ì™„ì „í•œ ë°ì´í„° ê°ì²´ì—¬ì•¼ í•¨\n"
            "- í•„ë“œëª…ì€ HTMLì˜ name ì†ì„±ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê³ , í•´ë‹¹ ì„¹ì…˜ì˜ ëª¨ë“  í•˜ìœ„ í•„ë“œë“¤ì„ í¬í•¨í•˜ì—¬ ë°°ì—´ ìš”ì†Œë¡œ êµ¬ì„±\n"
            "- ğŸš¨ ì¤‘ìš”: multidata_fieldëŠ” ì‹¤ì œ HTMLì˜ name ì†ì„±ì„ í™œìš©í•˜ì„¸ìš”. ì„ì˜ë¡œ ìƒì„±í•˜ì§€ ë§ê³  HTMLì„ ê·¸ëŒ€ë¡œ ì ê·¹ í™œìš©í•˜ì—¬ êµ¬ì¡°ë¥¼ êµ¬ì„±\n\n"
            "ì„¹ì…˜ 6) ì‘ë‹µ í˜•ì‹\n"
            "- ì˜¤ì§ expected_output ê°ì²´(JSON)ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€\n"
            "ì˜ˆ: {\n  \"ìƒíƒœ\": \"SUCCESS\" ë˜ëŠ” \"FAILED\",\n  \"ìˆ˜í–‰í•œ_ì‘ì—…\": \"ì½ê¸° ì¢‹ì€ ìì—°ì–´ í…ìŠ¤íŠ¸\",\n  \"í¼_ë°ì´í„°\": { /* í¼ í•„ë“œ í‚¤/ê°’ (ë¦¬í¬íŠ¸/ìŠ¬ë¼ì´ë“œ íƒ€ì… ì œì™¸) */ }\n}\n"
            "- ë¬¸ìì—´ë¡œ ê°ì‹¸ì§€ ë§ê³ , ë°±í‹±ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ìˆœìˆ˜ JSON ê°ì²´ë§Œ ë°˜í™˜í•˜ì„¸ìš”.\n"
            f"{report_slide_notice}"
        )

    def _build_system_prompt_description(self) -> str:
        """description ì „ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return (
            "ë‹¹ì‹ ì€ CrewAI Task descriptionì„ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n"
            "ì—­í• : ì£¼ì–´ì§„ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì—ì´ì „íŠ¸ê°€ ìˆ˜í–‰í•  êµ¬ì²´ì ì¸ ì‘ì—… ì§€ì‹œ(description)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n"
            "ì‘ë‹µ í˜•ì‹: ì„¤ëª… í…ìŠ¤íŠ¸ í•œ ë¬¸ë‹¨ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë°±í‹±/ì½”ë“œë¸”ë¡/JSON í¬ì¥ ê¸ˆì§€."
        )

    def _build_system_prompt_expected_output(self) -> str:
        """expected_output ì „ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return (
            "ë‹¹ì‹ ì€ CrewAI Task expected_outputì„ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n"
            "ì—­í• : ì£¼ì–´ì§„ í¼ ì •ë³´(form_types/form_html)ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ê²°ê³¼ í˜•ì‹(expected_output)ì„ ìƒì„±í•©ë‹ˆë‹¤.\n"
            "ì‘ë‹µ í˜•ì‹: ì˜¤ì§ JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë°±í‹±/ì½”ë“œë¸”ë¡/ë¬¸ìì—´ í¬ì¥ ê¸ˆì§€."
        )
    
    def _collect_dmn_analysis(
        self,
        agent_info: List[Dict],
        task_instructions: str,
    ) -> Dict[str, str]:
        """ì—ì´ì „íŠ¸ë³„ DMN ê·œì¹™ ë¶„ì„ ê²°ê³¼ ìˆ˜ì§‘: task_instructionsë¥¼ dmn_rule ì¿¼ë¦¬ë¡œ ì‚¬ìš©"""
        if not task_instructions or not task_instructions.strip():
            return {}

        dmn_results: Dict[str, str] = {}
        for ag in agent_info:
            agent_id = ag.get("id") or ag.get("user_id")
            tenant_id = ag.get("tenant_id")
            role = ag.get("role", "Unknown")
            if not (agent_id and tenant_id):
                continue
            try:
                tool = DMNRuleTool(tenant_id=tenant_id, user_id=agent_id)
                result = tool._run(task_instructions.strip())
                if result and isinstance(result, str):
                    dmn_results[role] = result
            except Exception as e:
                logger.warning("âš ï¸ ì—ì´ì „íŠ¸ %s DMN ê·œì¹™ ë¶„ì„ ì‹¤íŒ¨: %s", role, e)

        return dmn_results

